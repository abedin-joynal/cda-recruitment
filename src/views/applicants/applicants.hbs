<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 pt-2 font-weight-bold text-primary float-left"> <i class="fas fa-list"></i> Roles</h6>
        <a class="btn btn-outline-primary float-right" href="/roles/add" data-toggle="tooltip" data-placement="left" title="Create New Role">
            <i class="fas fa-plus"></i>
        </a>
    </div>
    
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" width="100%" cellspacing="0" id="example">
                <thead>
                    <tr class="table-dark">
                      <tr>
                        <th>#</th>
                        <th>Role Name</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                    </tr>
                </thead>
               
                <tbody>
                    {{#each applicants}}
                    <tr>
                        <td> {{ inc @index ../start_index }} </td>
                        <td> {{ name }} </td>
                        <td>
                            {{#if ../loggedinuser.permissions.role-delete }}
                            <a class="btn btn-outline-danger btn_delete" data-id="{{id}}" data-route="roles" href="javascript:void(0)" data-toggle="tooltip" data-placement="left" title="Delete">
                                <i class="fas fa-times"></i>
                            </a>
                            {{/if}}
                        </td>
                        <td>
                            {{#if ../loggedinuser.permissions.role-edit }}
                                <a class="btn btn-outline-primary" href="/roles/edit/{{id}}" data-toggle="tooltip" data-placement="left" title="Edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                            {{/if}}
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td class="text-center" colspan="4"><div class="alert alert-warning">No Data</div></td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>
  
<script>
  let VOTES;
  let CANDIDATES;

  var MATRIX = {};
  $(document).ready(async function () {

    new DataTable('#example');

    await getCandidateList();
    getAllVotes();
    
    async function votePolling() {
      let res = await axios.get('/votes/get-vote-data', {
        params: {
          pc_id: null
        }
      }).then(function (res) {
        console.log(res.data.emitted_data);
        genMatrix(res.data.emitted_data);
        genVoteCountUI();
        votePolling();
      });
    }

    async function getAllVotes() {
      let res = await axios.get('/votes/get-all-votes', {
        params: {
          data: null
        }
      }).then(function (res) {
        if (res.data.status) {
          VOTES = res.data.votes;
          genMatrix(VOTES)
          votePolling();
        }
        genVoteCountUI();
      });
    }

    async function genVoteCountUI() {
      $(".voter-card-container").empty();
      if(VOTES.length >= 1 ) {
        _.each(MATRIX, function (post, post_id) {
          let $mvc = $("#markup-voter-card").clone();
          $mvc.removeClass("display-none");
          $mvc.find(".post_name").html(post[0][_.keys(post[0])[0]][0].post_name);
          let ch = ``;
          let order = [];
          let i = 0;
          _.each(post[0], function (candidate, candidate_id) {
           
            order[i] = candidate;
            i++;
          });


          missing_can = candidateMissing(post[0]);
          console.log(missing_can);

          let z = bblSort(order);
          _.each(order, function (candidate, post_id) {
              ch += `<div>${candidate[0].candidate_name} : ${candidate.length}</div>`;
          });

          $mvc.find(".candidates").html(ch);
          $(".voter-card-container").append($mvc);
        });
      } else {
        $(".voter-card-container").html(`<div class="col-md-5 alert alert-primary text-center mt-5">Vote counting will start soon....</div>`);
      }
    }

    function candidateMissing(post) {
      let missing_can = [];
      console.log(post)
      _.each(CANDIDATES[post[_.keys(post)[0][0]]], function(can, index) {
          let m = false;
          
          _.each(post, function (candidate, candidate_id) {
            if(candidate.c_id == c.c_id) {
              m = true;
            }
          });
          if(m == false) {
            missing_can.push(can)
          }
      });
      return missing_can;
    }
    
    async function getCandidateList() {
      let res = await axios.get('/candidates/all', {timeout: 10000, params: {
              data: null
          }}).then(function(res) {
              if(res.data.status) {
                  CANDIDATES = _.groupBy(res.data.data, "post_id");
                  {{!-- console.log(CANDIDATES) --}}
              } else {
                  mobiscroll.snackbar({message: `Could not get candidates`, display: 'top', color: `danger`, duration:1500});
              }
          });    
    }

    function genMatrix(votes) {
      MATRIX = {};
      let VOTES_POST_GROUPED = _.groupBy(votes, "post_id");
      _.each(VOTES_POST_GROUPED, function (vpg, post_id) {
        let VOTES_CANDIDATE_GROUPED = _.groupBy(vpg, "candidate_id");
        MATRIX[post_id] = [];
        let y = [];
        let x = {};
        _.each(VOTES_CANDIDATE_GROUPED, function (vcg, candidate_id) {
          x[candidate_id] = vcg;
        });
        y.push(x);
        
        MATRIX[post_id] = y;
      });
    }

    function bblSort(arr) {
      for (let i = 0; i < arr.length; i++) {
        for (let j = 0; j < (arr.length - i - 1); j++) {
          if (arr[j].length < arr[j + 1].length) {
            let temp = arr[j]
            arr[j] = arr[j + 1]
            arr[j + 1] = temp
          }
        }
      }
      {{!-- console.log(arr); --}}
      return arr;
    }

  });


</script>