
<!DOCTYPE html>
<html>
    <head>
        <title>Demo - Capture Photo From Webcam Using Javascript</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
        <style type="text/css">

            button {
                width: 120px;
                padding: 10px;
                display: block;
                margin: 20px auto;
                border: 2px solid #111111;
                cursor: pointer;
                background-color: white;
            }

            #start-camera {
                margin-top: 50px;
            }

            #video {
                display: none;
                margin: 50px auto 0 auto;
            }

            #click-photo {
                display: none;
            }

            #dataurl-container {
                display: none;
            }

            #canvas {
                display: block;
                margin: 0 auto 20px auto;
            }

            #dataurl-header {
                text-align: center;
                font-size: 15px;
            }

            #dataurl {
                display: block;
                height: 100px;
                width: 320px;
                margin: 10px auto;
                resize: none;
                outline: none;
                border: 1px solid #111111;
                padding: 5px;
                font-size: 13px;
                box-sizing: border-box;
            }
            /*------------------*/

            img {
            max-width: 100%;
            /* This rule is very important, please do not ignore this! */
            }

            #canvas {
                /* height: 500px;
                width: 500px; */
                background-color: #ffffff;
                cursor: default;
                border: 1px solid black;
            }

            .img-container img {
            width: 100%;
            }
            /*------------------*/

        </style>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/cropper/2.3.3/cropper.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/2.3.3/cropper.js"></script>
        <script src="glfx.js"></script>
        <script src="application.js"></script>
    </head>
    <body>

        <button id="start-camera">Start Camera</button>
        <video id="video" width="400" height="450" style = 'width:200px; height:200px;' autoplay></video>
        <button id="click-photo">Click Photo</button>
       
        <!---------------------------->
        <p>
            <!-- Below are a series of inputs which allow file selection and interaction with the cropper api -->
            <!-- <input type="file" id="fileInput" accept="image/*" /> -->
            <!-- <input type="button" id="btnCrop" value="Crop" /> -->
            <!-- <input type="button" id="btnRestore" value="Restore" /> -->
        </p>
        <div id="canvas_container">
            <canvas id="canvas" class="img-container" width=350 height=400 style = 'width:200px; height:200px;' style="">
                Your browser does not support the HTML5 canvas element.
            </canvas>
        </div>

        <button type="button" id="btnCrop">CROP</button>

        <div id="dataurl-container">
            <!-- <canvas id="canvas" width="200" height="240"></canvas> -->
            <div id="dataurl-header">Image Data URL</div>
            <textarea id="dataurl" readonly></textarea>
        </div>

        
        <div id="result"></div>
        <!---------------------------->
        <!-- <img id="image" src="image.jpg" width="200" height="auto"> -->


        <script>
            let camera_button = document.querySelector("#start-camera");
            let video = document.querySelector("#video");
            let click_button = document.querySelector("#click-photo");
            let crop_button = document.querySelector("#btnCrop");
            var canvas = document.querySelector("#canvas");
            var canvas1 = $("#canvas");
            var $result = $('#result');
            let dataurl = document.querySelector("#dataurl");
            let dataurl_container = document.querySelector("#dataurl-container");

            let crop_coords = [];
            let cc_count = 0;

            camera_button.addEventListener('click', async function() {
                let stream = null;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment'}, audio: false });
                }
                catch(error) {
                    alert(error.message);
                    return;
                }

                video.srcObject = stream;

                video.style.display = 'block';
                camera_button.style.display = 'none';
                click_button.style.display = 'block';
            });

            click_button.addEventListener('click', function() {
                /*--- Reset Canvas ---------*/
                $("#canvas_container").empty();
                $("#canvas_container").html(`<canvas id="canvas" class="img-container" width="200" height="200"></canvas>`);
                canvas = document.querySelector("#canvas");
                canvas1 = $("#canvas");
                $result.empty();

                /*--- Reset Canvas ---------*/
                var aspect = video.videoHeight / video.videoWidth;
                var wantedWidth = 320;   // or use height
                var height = Math.round(wantedWidth * aspect);
                canvas.width = wantedWidth;
                canvas.height = height;

                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                let image_data_url = canvas.toDataURL('image/jpeg');
                // alert(image_data_url)
                dataurl.value = image_data_url;
                dataurl_container.style.display = 'block';
                
                // init();
                // return;
                /*--------------------*/            
                crop_coords = [];
                cc_count = 0;
                let curX = 0, curY = 0, prevX = 0, prevY = 0;

                function getCursorPosition(canvas, event) {
                    if(cc_count>3) return;

                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    let ctx = canvas.getContext("2d");
                    
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "#ffffff";
                    
                    curX = x; curY = y;
                    if(cc_count == 0) {
                        ctx.beginPath();
                        ctx.moveTo(curX, curY);
                    } else {
                        ctx.lineTo(curX, curY); // Draw a line to (150, 100)
                        ctx.stroke(); // Render the path
                        ctx.moveTo(curX, curY);
                        if(cc_count == 3) {
                            ctx.lineTo(crop_coords[0].x, crop_coords[0].y); // Draw a line to (150, 100)
                            ctx.stroke(); // Render the path
                        }
                    }
                    prevX = curX; prevY = curY;
                    ctx.fillRect(curX, curY, 2, 2);
                    // console.log("x: " + x + " y: " + y);
                    crop_coords.push({"x" : curX, "y" : curY});
                    cc_count++;
                }

                canvas.addEventListener('mousedown', function(e) {
                    getCursorPosition(canvas, e);
                });
                /*--------------------*/
            });

            crop_button.addEventListener('click', function() {
            // $(document).on("#btnCrop", "click", function() {
                var canvasfx = fx.canvas();
                var image = document.getElementById('canvas');
                let texture = canvasfx.texture(image);
                canvasfx.draw(texture).
                // ink(0.25).
                perspective([crop_coords[0].x, crop_coords[0].y, crop_coords[1].x, crop_coords[1].y, 
                            crop_coords[3].x, crop_coords[3].y, crop_coords[2].x, crop_coords[2].y], 
                             [0,0, canvas.width,0, 
                              0,canvas.height, canvas.width,canvas.height]).
                update();
                let image_data_url = canvas.toDataURL('image/jpeg');
                dataurl.value = image_data_url;

                image.parentNode.insertBefore(canvasfx, image);
                image.parentNode.removeChild(image);

            });

            window.onload = function() {
                $("#start-camera").click();
            };

        </script>
    </body>
</html>