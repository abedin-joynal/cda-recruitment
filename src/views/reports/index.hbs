<!-- Reports Page -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 pt-2 font-weight-bold text-primary">
            <i class="fas fa-chart-bar"></i> Reports
        </h6>
        <div class="float-right">
            <a href="/" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-home"></i> Go Back to Homepage
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Post Selection Dropdown -->
        <div class="form-group row mb-4">
            <label for="postSelect" class="col-sm-2 col-form-label font-weight-bold">Select Post:</label>
            <div class="col-sm-10">
                <select class="form-control" id="postSelect">
                    <option value="">-- Select a Post --</option>
                    {{#each posts}}
                    <option value="{{id}}">{{name}}</option>
                    {{/each}}
                </select>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Loading applicants...</p>
        </div>

        <!-- Applicants Table Container -->
        <div id="applicantsContainer" style="display: none;">
            <!-- Controls -->
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="chk-convert-to-unicode-report" checked>
                    <label class="custom-control-label" for="chk-convert-to-unicode-report">Convert Names to Unicode</label>
                </div>
                <button id="btnDownloadPDF" class="btn btn-primary">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
            </div>

            <!-- Report Content for PDF -->
            <div id="reportContent" style="background: white; width: 210mm;">
                <!-- This will be populated with pages -->
                <div id="pdfPagesContainer"></div>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="alert alert-info text-center" style="display: none;">
            <i class="fas fa-info-circle"></i> No applicants found for the selected post.
        </div>
    </div>
</div>

<!-- Load required scripts -->
<script type="text/javascript" src="/js/bijoy2Unicode/base.js"></script>
<script type="text/javascript" src="/js/bijoy2Unicode/bijoy.js"></script>

<style>
    /* Report Print Styles */
    @media print {
        body * {
            visibility: hidden;
        }
        #reportContent, #reportContent * {
            visibility: visible;
        }
        #reportContent {
            position: absolute;
            left: 0;
            top: 0;
            width: 210mm;
        }
        .pdf-page {
            page-break-after: always;
            page-break-inside: avoid;
        }
        .pdf-page:last-child {
            page-break-after: auto;
        }
    }

    /* PDF Page Styling */
    .pdf-page {
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        background: white;
        margin-bottom: 10px;
        box-sizing: border-box;
        font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Report header styling */
    .report-header-box {
        border: 2px solid #111;
        padding: 8px 10px;
        text-align: center;
        margin-bottom: 15px;
        font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Table styling for PDF */
    .pdf-table {
        font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
        font-size: 10px;
        color: #111;
    }
    
    .pdf-table td {
        padding: 8px 5px;
        vertical-align: middle;
        border: 1px solid #999;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    .pdf-table th {
        padding: 8px 5px;
        text-align: center;
        font-weight: 600;
        background-color: transparent;
        color: #111;
        border: 1px solid #999;
        font-size: 10px;
    }
    
    .pdf-table tbody tr {
        height: 52px;
        page-break-inside: avoid;
    }

    /* Stamp-sized image for PDF */
    .pdf-stamp-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
        display: block;
        margin: 0 auto;
    }

    /* Page number styling */
    .page-number {
        text-align: center;
        margin-top: 10px;
        font-size: 10px;
        color: #666;
    }

    /* Table styling for screen view */
    #applicantsTable {
        font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
        color: #111;
    }
    #applicantsTable td {
        padding: 8px;
        vertical-align: middle;
        border: 1px solid #999;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    #applicantsTable th {
        padding: 10px 8px;
        text-align: center;
        font-weight: 600;
        background-color: transparent;
        color: #111;
        border: 1px solid #999;
    }
    #applicantsTable tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    #applicantsTable tbody tr:hover {
        background-color: #e9ecef;
    }
    .stamp-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
</style>

<script>
$(document).ready(function() {
    let currentApplicants = [];
    let currentPostInfo = {};

    // Handle post selection change
    $('#postSelect').on('change', function() {
        const postId = $(this).val();
        
        if (!postId) {
            $('#applicantsContainer').hide();
            $('#noDataMessage').hide();
            return;
        }

        // Show loading indicator
        $('#loadingIndicator').show();
        $('#applicantsContainer').hide();
        $('#noDataMessage').hide();

        // Fetch applicants for selected post
        axios.get('/reports/getApplicantsByPost', {
            params: {
                post_id: postId
            }
        })
        .then(function(response) {
            console.log(response.data.data);
            $('#loadingIndicator').hide();
            if (response.data.status && response.data.data && response.data.data.length > 0) {
                currentApplicants = response.data.data;
                // Store post info from first applicant (all should have same post info)
                if (currentApplicants.length > 0) {
                    currentPostInfo = {
                        post_name: currentApplicants[0].post_name || '',
                        exam_date: currentApplicants[0].exam_date || '',
                        exam_center: currentApplicants[0].exam_center || ''
                    };
                }
                displayApplicants(currentApplicants);
                $('#applicantsContainer').show();
                $('#noDataMessage').hide();
            } else {
                $('#applicantsContainer').hide();
                $('#noDataMessage').show();
            }
        })
        .catch(function(error) {
            $('#loadingIndicator').hide();
            $('#applicantsContainer').hide();
            $('#noDataMessage').show();
            $('#noDataMessage').html('<i class="fas fa-exclamation-triangle"></i> Error loading applicants. Please try again.');
            console.error('Error fetching applicants:', error);
        });
    });

    function createHeaderHTML() {
        return `
            <div class="report-header-box">
                <img src="/img/cda-logo.png" alt="CDA Logo" style="width: 45px; height: 45px; border-radius: 50%; margin: 0 auto 4px; display: block; object-fit: contain;">
                <div style="font-weight: 700; font-size: 16px; line-height: 1.2; margin: 0; color: #000000;">চট্টগ্রাম উন্নয়ন কর্তৃপক্ষ</div>
                <div style="font-size: 12px; line-height: 1.35; margin: 2px 0; color: #000000;">চউক ভবন, চট্টগ্রাম</div>
                <div style="font-size: 12px; line-height: 1.35; margin: 2px 0; color: #000000;">www.cda.gov.bd</div>
                <div style="font-size: 12px; line-height: 1.35; margin: 8px 0 4px; text-align: left; padding-left: 20px; color: #000000;">
                    <div style="font-weight: 600; margin-bottom: 4px; color: #000000;">পদের নাম: ${currentPostInfo.post_name || '-'}</div>
                    <div style="margin-bottom: 2px; color: #000000; font-weight: 700;">পরীক্ষার তারিখ: ${currentPostInfo.exam_date || '-'}</div>
                    <div style="margin-bottom: 2px; color: #000000; font-weight: 700;">পরীক্ষাকেন্দ্র: ${currentPostInfo.exam_center || '-'}</div>
                </div>
            </div>
        `;
    }

    function displayApplicants(applicants) {
        const container = $('#pdfPagesContainer');
        container.empty();
        const convertToUnicode = $('#chk-convert-to-unicode-report').is(':checked');
        
        const applicantsPerPage = 10;
        const totalPages = Math.ceil(applicants.length / applicantsPerPage);

        // Create pages
        for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
            const startIndex = pageIndex * applicantsPerPage;
            const endIndex = Math.min(startIndex + applicantsPerPage, applicants.length);
            const pageApplicants = applicants.slice(startIndex, endIndex);

            const pageHTML = createPageHTML(pageApplicants, pageIndex + 1, totalPages, startIndex, convertToUnicode);
            container.append(pageHTML);
        }
    }

    function createPageHTML(pageApplicants, pageNum, totalPages, startIndex, convertToUnicode) {
        let tableRows = '';
        
        pageApplicants.forEach(function(applicant, index) {
            const serial = startIndex + index + 1;
            const img = applicant.img ? `/img/applicants/${applicant.img}` : `/img/no-image.jpg`;
            const rollNo = applicant.roll_no || '';
            
            // Convert names to Unicode if checkbox is checked
            let name = applicant.name || '';
            let fatherName = applicant.father_name || '';
            let motherName = applicant.mother_name || '';
            
            if (convertToUnicode && typeof ConvertToUnicode === 'function') {
                name = ConvertToUnicode('bijoy', name);
                fatherName = ConvertToUnicode('bijoy', fatherName);
                motherName = ConvertToUnicode('bijoy', motherName);
            }

            const parentsName = (fatherName && motherName) ? `${fatherName} / ${motherName}` : (fatherName || motherName || '');

            tableRows += `
                <tr>
                    <td style="width: 30px; text-align: center;">${serial}</td>
                    <td style="width: 50px; text-align: center;">${rollNo}</td>
                    <td style="width: 70px; text-align: center;">
                        <img src="${img}" alt="Applicant Image" class="pdf-stamp-image">
                    </td>
                    <td style="width: 120px;">${name}</td>
                    <td style="width: 144px;">${parentsName}</td>
                    <td style="width: 200px; text-align: center; height: 60px;"></td>
                </tr>
            `;
        });

        return `
            <div class="pdf-page">
                ${createHeaderHTML()}
                <table class="pdf-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;">ক্রম</th>
                            <th style="width: 50px;">রোল নং</th>
                            <th style="width: 70px;">ছবি</th>
                            <th style="width: 120px;">আবেদনকারীর নাম</th>
                            <th style="width: 144px;">বাবা ও মায়ের নাম</th>
                            <th style="width: 200px;">স্বাক্ষর</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                <div class="page-number">পৃষ্ঠা ${pageNum} / ${totalPages}</div>
            </div>
        `;
    }

    // Toggle Unicode conversion
    $('#chk-convert-to-unicode-report').on('change', function() {
        if (currentApplicants.length > 0) {
            displayApplicants(currentApplicants);
        }
    });

    // PDF Download Handler
    $('#btnDownloadPDF').on('click', function() {
        const container = document.getElementById('pdfPagesContainer');
        const btn = $(this);
        
        if (!container || !container.children.length) {
            alert('Report content not found. Please select a post first.');
            return;
        }
        
        // Check if required libraries are available
        if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
            alert('PDF libraries not loaded. Please refresh the page and try again.');
            return;
        }
        
        // Show loading
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generating PDF...');

        // Wait for images to load
        setTimeout(function() {
            const pages = container.querySelectorAll('.pdf-page');
            // Generate date string (YYYY-MM-DD)
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            const postName = (currentPostInfo.post_name || 'report').replace(/[^a-z0-9]/gi, '_');
            const filename = 'Attendance_sheet_' + postName + '_' + dateStr + '.pdf';
            
            // A4 dimensions in points (72 DPI)
            const A4_WIDTH = 595.28;
            const A4_HEIGHT = 841.89;
            const margin = 20;
            const pdf = new jsPDF('p', 'pt', 'a4');
            
            let pageIndex = 0;
            
            function processPage() {
                if (pageIndex >= pages.length) {
                    pdf.save(filename);
                    btn.prop('disabled', false).html('<i class="fas fa-file-pdf"></i> Download PDF');
                    return;
                }
                
                const page = pages[pageIndex];
                
                html2canvas(page, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    width: page.offsetWidth,
                    height: page.offsetHeight
                }).then(function(canvas) {
                    const imgData = canvas.toDataURL("image/jpeg", 0.95);
                    
                    if (pageIndex > 0) {
                        pdf.addPage();
                    }
                    
                    // Calculate dimensions to fit A4
                    const imgWidth = A4_WIDTH - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'JPG', margin, margin, imgWidth, imgHeight);
                    
                    pageIndex++;
                    processPage();
                }).catch(function(error) {
                    console.error('Canvas generation error:', error);
                    btn.prop('disabled', false).html('<i class="fas fa-file-pdf"></i> Download PDF');
                    alert('Error generating PDF: ' + (error.message || 'Unknown error'));
                });
            }
            
            processPage();
        }, 1000);
    });
});
</script>
