<style>
    table tbody {
        display: block;
        max-height: 500px;
        overflow-y: scroll;
    }

    table thead, table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    table thead th {
        font-size: small;
    }
     table tbody td {
        font-size: small;
    }
</style>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 pt-2 font-weight-bold text-primary float-left"> <i class="fas fa-list"></i> Vote Entry Form</h6>
            </div>

            <div class="card-body">
                <div class="">
                    <form action="javascript:void(0)" method="POST">
                        <fieldset class="form-group">
                            <label for="first_name">Post<span class="text-danger">*</span></label>
                            <select name="post_id" class="form-control">
                                <option value="null">Select a post</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="first_name">Candidate<span class="text-danger">*</span></label>
                            <select name="candidate_id" class="form-control">
                                <option value="null">Select a candidate</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="last_name">Voter Name</label>
                            <input type="text" name="voter-name" class="form-control"
                                placeholder="Voter Name" value="">
                            <div class="invalid-feedback"></div>
                        </fieldset>

                        <fieldset class="form-group">
                            <label for="last_name">Voter Details</label>
                            <input type="text" name="voter-details" class="form-control"
                                placeholder="Voter Details" value="">
                            <div class="invalid-feedback"></div>
                        </fieldset>

                        <hr />
                        <fieldset class="form-group text-center">
                            <a href="javascript:void(0)" class="btn btn-danger btn-sm display-none" data-toggle="tooltip" data-placement="left"
                                title="Cancel">Cancel</a>
                            <a href="javascript:void(0)" id="btn-save-vote" class="btn btn-info btn-sm" title="Save">Save</a>
                        </fieldset>
                        <input type="hidden" id="cur_user_company_id" value="{{cur_user_company_id}}" />
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="col-md-6">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="m-0 pt-2 font-weight-bold text-primary float-left"> <i class="fas fa-list"></i> Vote list
                                </h6>
                            </div>
                            <div class="col-md-8 text-right">
                                <form method="GET" action="/votes/download-csv">
                                    {{!-- <button type="button" id="btn-vote-list" class="btn btn-outline-site btn-sm  m-2"><i class="fa fa-print"></i></button>
                                    <button type="button" id="btn-download-pdf" class="btn btn-outline-site  btn-sm m-2"><i class="fa fa-file-pdf"></i></button> --}}
                                    <button type="submit" id="filter-download-csv-btn" class="btn btn-outline-site btn-sm " data-toggle="tooltip" data-placement="left" title="" data-original-title="Download CSV">
                                        <i class="fa fa-download"></i> Download CSV
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="">
                            <table id="table-voter-list" class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Candidate</th>
                                        <th>Post</th>
                                        <th>Voter</th>
                                        <th>Details</th>
                                    </tr>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td> {{ username }} </td>
                                        <td> {{ fullname }} </td>
                                        <td> {{ role_name }} </td>
                                        <td>
                                            <a class="btn btn-outline-danger btn-sm btn_delete" data-user-id="{{id}}"
                                                href="javascript:void(0)" data-toggle="tooltip" data-placement="left"
                                                title="Delete">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <a class="btn btn-outline-site btn-sm" href="/users/edit/{{id}}"
                                                data-toggle="tooltip" data-placement="left" title="Edit">
                                                <i class="fas fa-pencil-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="input-posts" value="{{toJson posts}}">
<input type="hidden" id="input-candidates" value="{{toJson candidates}}">
<input type="hidden" id="input-postCandidates" value="{{toJson postCandidates}}">
<input type="hidden" id="input-votes" value="{{toJson votes}}">

<script>
    let POSTS, CANDIDATES, POSTCANDIDATES, VOTES = null;
    POSTS = JSON.parse($("#input-posts").val());
    CANDIDATES = JSON.parse($("#input-candidates").val());
    POSTCANDIDATES = JSON.parse($("#input-postCandidates").val());
    VOTES = JSON.parse($("#input-votes").val());
    let POSTGROUPED = _.groupBy(POSTS, "id");
    let CANDIDATEGROUPED = _.groupBy(CANDIDATES, "id");
    let PCGROUPED = _.groupBy(POSTCANDIDATES, "post_id");

    genPostDD();
    genVoteList();

    function genPostDD() {
        let h = ``;
        _.each(POSTS, function(item, index) {
            h += `<option value="${item.id}">${item.name}</option>`
        });
        $("select[name=post_id]").append(h);
    }

    function genVoteList() {
        let h = ``;
        if(VOTES.length >=1) {
       _.each(VOTES, function(item, index) {
            h += `<tr>
                    <td>${item.id}</td>
                    <td>${item.candidate_name}</td>
                    <td>${item.post_name}</td>
                    <td>${item.voter_name}</td>
                    <td>${item.voter_details}</td>
                  </tr>`;
        }); 
        } else {
            h = `<tr>
                    <td colspan="5"><div class="alert alert-primary text-center">No Data</div></td>
                  </tr>`;
        }
        $("#table-voter-list tbody").html(h);
    }

    $(document).on("change", "select[name=post_id]", function () {
        let post_id = $(this).val();
        let p_candidates = PCGROUPED[post_id];
        let h = ``;
        if(p_candidates.length >= 1) {
            h = `<option value="null">Select a candidate</option>`;
            _.each(p_candidates, function(item, index) {
                let c = CANDIDATEGROUPED[item.candidate_id];
                h += `<option value="${c[0].id}">${c[0].name}</option>`
            });
        } else {
            h = `<option value="null">No candidate</option>`;
        }
        $("select[name=candidate_id]").html(h); 
    });

    $(document).on("click", "#btn-save-vote", async function () {
        let p_id = $("select[name=post_id]").val();
        let c_id = $("select[name=candidate_id]").val();
        let v_name = $("input[name=voter-name]").val(); 
        let v_details = $("input[name=voter-details]").val(); 
        let pc_id = null;
        _.each(PCGROUPED[p_id], function(item, index) {
            if(item.candidate_id == c_id) {
                pc_id = item.id;
            }
        });
        let error = false;
        if(p_id == "null") {
            error = `Select A Post`;
        } else if (c_id == "null") {
            error = `Select A Candidate`;
        } else if(pc_id == null) {
            error = `Something Went Wrong`;
        }

        if(!error) {
            let res = await axios.get('/votes/save-vote', {timeout: 10000, params: {
                pc_id: pc_id, v_name: v_name, v_details: v_details
            }}).then(function(res) {
                if(res.data.status) {
                    {{!-- $(".mbsc-popup-body").remove(); --}}
                    mobiscroll.snackbar({message: `Vote Saved Successfully`, display: 'top', color: `success`, duration:1500});
            
                    resetVoteEntryForm();

                    let h = `<tr>
                                <td>${res.data.insertid}</td>
                                <td>${CANDIDATEGROUPED[c_id][0].name}</td>
                                <td>${POSTGROUPED[p_id][0].name}</td>
                                <td>${v_name}</td>
                                <td>${v_details}</td>
                            </tr>`;
                    $("#table-voter-list tbody").prepend(h);
                } else {
                    // Notify
                }
            });    
        } else {
            mobiscroll.snackbar({message: error, display: 'top', color: `danger`});
        }

    });

    $(document).on("click", "#btn-vote-list", function () {
        printDiv("table-voter-list");
    });

    $(document).ready(function () {
        $(document).on("click", ".btn_delete", function () {
            let user_id = $(this).attr("data-user-id")
            $("#deleteModal").modal('show');
            $("#deleteModal").find("#btn_delete").attr("href", "/users/delete/" + user_id)
        });
    });

    function resetVoteEntryForm() {
        $("select[name=post_id]").val('null');
        $("select[name=candidate_id]").val('null');
        $("input[name=voter-name]").val('');
        $("input[name=voter-details]").val('');

        $("select[name=post_id]").click();

        {{!-- let event;
        event = document.createEvent('MouseEvents');
        event.initMouseEvent('mousedown', true, true, window);
        document.querySelector("select[name=post_id]").dispatchEvent(event); --}}
    }
</script>